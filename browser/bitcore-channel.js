'use strict';(function(){function b(a){a=a||{};this.network=a.network||"livenet";this.expires=a.expires||(new Date).getTime()+864E5;this.commitmentKey=a.commitmentKey||c.Key.generateSync();e.checkArgument(a.providerPublicKey,"Must provide a public key for the provider");if(f.isString(a.providerPublicKey)){var b=new c.Key;b.public=new d.Buffer(a.providerPublicKey,"hex");a.providerPublicKey=b}e.checkArgument(a.providerPublicKey instanceof c.Key,"Invalid public key provided");this.providerPublicKey=
a.providerPublicKey;e.checkArgument(a.providerAddress);this.providerAddress=a.providerAddress;this.fundingKey=a.fundingKey||c.Key.generateSync();this.fundingAddress=c.Address.fromPubKey(this.fundingKey.public,this.network);a.refundAddress?this.refundAddress=a.refundAddress instanceof c.Address?a.refundAddress:new c.Address(a.refundAddress):(this.refundKey=c.Key.generateSync(),this.refundAddress=c.Address.fromPubKey(this.refundKey.public,this.network));this.commitmentTx=new g({pubkeys:[this.commitmentKey.public,
this.providerPublicKey.public],network:this.network});this.fundingWalletKey=new c.WalletKey({network:c.networks[this.network],privKey:this.fundingKey});this.commitmentTx.addKey(this.fundingWalletKey);this.commitmentWalletKey=new c.WalletKey({network:c.networks[this.network],privKey:this.commitmentKey})}var f=require("lodash"),c=require("bitcore"),d=require("buffer"),e=require("preconditions").singleton(),g=require("./transactions/Commitment"),a=require("./transactions/Payment"),h=require("./transactions/Refund");
b.prototype.processFunding=function(a){if(f.isArray(a))this.commitmentTx.addInputs(a);else if(f.isObject(a))this.commitmentTx.addInput(a);else throw Error("Can only process an array of objects or an object");};b.prototype.getRefundTxToSign=function(){var a=this.commitmentTx.build(),b=this.commitmentTx._calculateAmount(),a={txid:a.getHash(),vout:0,amount:b/1E8,amountSatStr:b,address:this.commitmentTx._address.toString(),scriptPubKey:this.commitmentTx.outscript.getBuffer()};this.refundTx=new h({multisigOut:a,
amount:b,refundAddress:this.refundAddress,pubKeys:this.commitmentTx.pubkeys,lockTime:this.expires,network:this.network});return this.refundTx.serialize()};b.prototype.validateRefund=function(b){b=new h(JSON.parse(b));b.sign([this.commitmentWalletKey]);e.checkState(b.isSigned());var c=b.builder.build(),d=this.refundTx.builder.build();e.checkState(1===c.outs.length);e.checkState(c.outs[0].s.toString("hex")===d.outs[0].s.toString("hex"));e.checkState(c.outs[0].v.toString("hex")===d.outs[0].v.toString("hex"));
this.refundTx=b;c=this.commitmentTx.build();b=this.commitmentTx._calculateAmount();c={txid:c.getHash(),vout:0,amount:b/1E8,amountSatStr:b,address:this.commitmentTx._address.toString(),scriptPubKey:this.commitmentTx.outscript.getBuffer()};this.paymentTx=new a({multisigOut:c,amount:b,changeAddress:this.refundAddress,paymentAddress:this.serverAddress,pubKeys:this.commitmentTx.pubkeys,network:this.network});this.paymentTx.sign([this.commitmentWalletKey]);return!0};b.prototype.incrementPaymentBy=function(a){this.paymentTx.updateValue(a);
this.paymentTx.sign([this.commitmentWalletKey])};b.prototype.sendToProvider=function(){return this.paymentTx.serialize()};module.exports=b})();(function(){function b(a){a.paymentAddress?this.paymentAddress=a.paymentAddress:(this.paymentKey=new c.Key,this.paymentAddress=d.createAddress(this.paymentKey.public));this.network=a.network||"livenet";this.key=a.key||c.Key.generateSync();this.walletKey=new c.WalletKey({privKey:this.key,network:c.networks[this.network]})}require("lodash");var f=require("preconditions").singleton(),c=require("bitcore"),d=require("./util/util"),e=require("./transactions/Payment"),g=require("./transactions/Refund");
b.prototype.getPublicKey=function(){return this.key.public.toString("hex")};b.prototype.signRefund=function(a){a=new g(JSON.parse(a));a.sign([this.walletKey]);return{refund:a.serialize(),paymentAddress:this.paymentAddress}};b.prototype.validPayment=function(a){a=new e(JSON.parse(a));a.sign([this.walletKey]);f.checkState(a.isSigned());this.paymentTx=a;this.currentAmount=c.util.valueToBigInt(a.builder.build().outs[0].v);return!0};b.prototype.getPaymentTx=function(){return this.paymentTx.build()};module.exports=
b})();(function(){function b(b){d.checkArgument(b.pubkeys&&2===b.pubkeys.length,"Must provide exactly two public keys");this.pubkeys=b.pubkeys;this.network=b.network||"livenet";this.inputs=[];this.keys=[];this.builder=new c.TransactionBuilder({spendUnconfirmed:!0})}var f=require("lodash"),c=require("bitcore"),d=require("preconditions").singleton(),e=require("../util/util");b.prototype.getAddress=function(){this._address||(this.outscript=c.Script.createMultisig(2,this.pubkeys),this._address=c.Address.fromScript(this.outscript.getBuffer().toString("hex"),
this.network));return this._address};b.prototype._calculateAmount=function(){var b=this;this.amount=0;f.each(this.inputs,function(a){e.assertUsesSatoshis(a);b.amount+=a.amountSat});return this.amount};b.prototype.addInput=function(b){e.assertUsesSatoshis(b);this.inputs.push(b);this.builder.setUnspent(this.inputs);this.builder.setOutputs({address:this.getAddress().toString(),amountSatStr:this._calculateAmount()-e.STANDARD_FEE})};b.prototype.addKey=function(b){this.keys.push(b);this.inputs.length&&
this.builder.sign([b])};b.prototype.addInputs=function(b){var a=this;b.map(function(b){a.addInput(b)})};b.prototype.addKeys=function(b){var a=this;b.map(function(b){a.addKey(b)})};b.prototype.build=function(){this.builder.sign(this.keys);var b=this.builder.build();d.checkState(b.isComplete(),"Some provided inputs couldnt be signed");return b};module.exports=b})();(function(){function b(a){this.paymentAddress=a.paymentAddress instanceof d.Address?a.paymentAddress:new d.Address(a.paymentAddress);this.changeAddress=a.changeAddress instanceof d.Address?a.changeAddress:new d.Address(a.changeAddress);this.pubKeys=a.pubKeys;f.any(this.pubKeys,function(a){return!(a instanceof c.SlowBuffer)})&&(this.pubKeys=this.pubKeys.map(function(a){return new c.Buffer(a)}));this.p2shMap={};this.p2shMap[a.multisigOut.address]=d.Script.createMultisig(2,this.pubKeys).getBuffer().toString("hex");
this.multisigOut=a.multisigOut;this.amount=a.amount;this.paid=a.paid||0;this.sequence=a.sequence||0;this.builder=a.builder?d.TransactionBuilder.fromObj(a.builder):(new d.TransactionBuilder({spendUnconfirmed:!0})).setUnspent([a.multisigOut]).setOutputs([{address:this.changeAddress.toString(),amountSatStr:this.amount-g.STANDARD_FEE}]).setHashToScriptMap(this.p2shMap)}var f=require("lodash"),c=require("buffer"),d=require("bitcore"),e=require("preconditions").singleton(),g=require("../util/util");require("./Commitment");
b.prototype.updateValue=function(a){this.paid+=a;this.sequence+=1;this.builder=(new d.TransactionBuilder({spendUnconfirmed:!0,remainderOut:{address:this.changeAddress.toString()}})).setUnspent([this.multisigOut]).setOutputs([{address:this.paymentAddress.toString(),amountSatStr:this.paid}]).setHashToScriptMap(this.p2shMap);return this};b.prototype.isSigned=function(){return this.builder.build().isComplete()};b.prototype.sign=function(a){this.builder.sign(a);return this};b.prototype.serialize=function(){return JSON.stringify({paymentAddress:this.paymentAddress.toString(),
changeAddress:this.changeAddress.toString(),pubKeys:this.pubKeys,multisigOut:this.multisigOut,amount:this.amount,paid:this.paid,sequence:this.sequence,builder:this.builder.toObj()})};b.prototype.build=function(){e.checkState(this.isSigned(),"Transaction must be fully signed!");return this.builder.build().serialize().toString("hex")};module.exports=b})();(function(){function b(a){this.refundAddress=a.refundAddress instanceof c.Address?a.refundAddress:new c.Address(a.refundAddress);this.refundAddress.data||(console.trace(),console.log(this.refundAddress));this.amount=a.amount;this.multisigOut=a.multisigOut;this.pubKeys=a.pubKeys;f.any(this.pubKeys,function(a){return!(a instanceof d.SlowBuffer)})&&(this.pubKeys=this.pubKeys.map(function(a){return new d.Buffer(a)}));this.p2shMap={};this.p2shMap[a.multisigOut.address]=c.Script.createMultisig(2,this.pubKeys).getBuffer().toString("hex");
this.builder=a.builder?c.TransactionBuilder.fromObj(a.builder):(new c.TransactionBuilder({spendUnconfirmed:!0,lockTime:a.lockTime})).setUnspent([a.multisigOut]).setOutputs([{address:this.refundAddress.toString(),amountSatStr:this.amount-g.STANDARD_FEE}]).setHashToScriptMap(this.p2shMap)}var f=require("lodash"),c=require("bitcore"),d=require("buffer"),e=require("preconditions").singleton(),g=require("../util/util");require("./Commitment");b.prototype.isSigned=function(){return this.builder.build().isComplete()};
b.prototype.sign=function(a){this.builder.sign(a)};b.prototype.serialize=function(){return JSON.stringify({pubKeys:this.pubKeys,multisigOut:this.multisigOut,amount:this.amount,p2shMap:this.p2shMap,refundAddress:this.refundAddress.toString(),builder:this.builder.toObj()})};b.prototype.build=function(){var a=this.builder.build();e.checkState(a.isComplete(),"Transaction must be fully signed!");return a.serialize().toString("hex")};module.exports=b})();(function(){})();(function(){function b(b){return/[0-9a-fA-F]+/.test(b)}var f=require("bitcore"),c=require("lodash");module.exports={STANDARD_FEE:1E4,assertUsesSatoshis:function(b){b.amountSat||b.amountSatStr||(b.amountSat=Math.round(b.amount*f.util.COIN),b.amountSatStr=Math.round(b.amount*f.util.COIN))},createAddress:function(b,c){return f.Address.fromPubKey(b,c||"livenet").toString()},isHexa:b,isCompressedPubkey:function(d){return c.isString(d)&&b(d)&&66===c.size(d)}}})();
